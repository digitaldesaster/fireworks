<!-- Sticky Navigation -->
<nav
  class="navbar bg-base-100 flex items-center justify-between p-4 sticky top-0 z-[60] shadow-sm"
>
  <div class="navbar-start">
    <a
      href="{{ url_for('index') }}"
      class="link text-base-content/90 text-xl font-semibold no-underline flex items-center gap-2"
    >
      Fireworks
    </a>
  </div>
  <div class="navbar-end flex items-center gap-2">
    <!-- User Avatar Dropdown for Desktop -->
    <div
      class="dropdown relative inline-flex max-lg:hidden [--auto-close:inside] [--offset:8] [--placement:bottom-end]"
    >
      <button
        type="button"
        class="dropdown-toggle avatar placeholder"
        aria-haspopup="menu"
        aria-expanded="false"
        aria-label="User menu"
      >
        <div class="bg-primary text-primary-content rounded-full w-10">
          <span class="text-lg"
            >{{ current_user.firstname[0] }}{{ current_user.name[0] }}</span
          >
        </div>
      </button>
      <ul
        class="dropdown-menu dropdown-open:opacity-100 hidden min-w-48"
        role="menu"
      >
        <div class="dropdown-header">
          <h6 class="text-base-content/90 text-base">
            {{ current_user.firstname }} {{ current_user.name }}
          </h6>
        </div>
        <form action="{{ url_for('logout') }}" method="post">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
          <button type="submit" class="dropdown-item w-full text-left">
            <span class="icon-[tabler--logout-2] size-5"></span>
            Sign Out
          </button>
        </form>
      </ul>
    </div>
    <!-- Mobile Menu Button -->
    <button
      type="button"
      class="btn btn-text max-lg:btn-square lg:hidden"
      aria-haspopup="dialog"
      aria-expanded="false"
      aria-controls="mobile-menu-overlay"
      data-overlay="#mobile-menu-overlay"
    >
      <span class="icon-[tabler--menu-2] size-5"></span>
    </button>
  </div>
</nav>

<aside
  id="mobile-menu-overlay"
  class="overlay drawer drawer-start w-64 max-w-64 lg:fixed lg:top-[57px] lg:bottom-0 lg:left-0 lg:z-40 lg:flex lg:translate-x-0 overlay-open:translate-x-0 -translate-x-full transition-transform duration-300"
  tabindex="-1"
>
  <div class="drawer-body w-64 bg-white h-full flex flex-col overflow-hidden">
    <!-- Fixed Header Section -->
    <div class="px-2 pt-4 pb-2 border-b border-base-200 flex-none">
      <ul class="menu w-full space-y-0.5 p-0">
        <li class="w-full">
          <a
            href="{{ url_for('index') }}"
            class="flex items-center gap-2 px-4 py-2 w-full"
          >
            <span class="icon-[tabler--dashboard] size-5 shrink-0"></span>
            <span class="truncate">Dashboard</span>
          </a>
        </li>
        <li class="w-full">
          <a
            href="{{ url_for('dms_chat.chat') }}"
            class="flex items-center gap-2 px-4 py-2 w-full"
          >
            <span class="icon-[tabler--message] size-5 shrink-0"></span>
            <span class="truncate">Chat</span>
          </a>
        </li>
      </ul>
    </div>

    <!-- Scrollable Content Section -->
    <div
      class="flex-1 overflow-y-auto scrollbar-thin scrollbar-thumb-base-300 scrollbar-track-transparent px-2 py-2"
    >
      <ul
        class="menu w-full space-y-0.5 [&_.nested-collapse-wrapper]:space-y-0.5 [&_ul]:space-y-0.5 p-0 pb-6"
      >
        <li class="w-full space-y-0.5">
          <button
            type="button"
            class="collapse-toggle w-full flex items-center gap-2 px-4 py-2 collapse-open:bg-base-content/10"
            id="prompts-collapse"
            aria-expanded="false"
            aria-controls="prompts-collapse-content"
            data-collapse="#prompts-collapse-content"
          >
            <span class="icon-[tabler--app-window] size-5 shrink-0"></span>
            <span class="truncate flex-1">Prompts</span>
            <span
              class="icon-[tabler--chevron-down] collapse-open:rotate-180 size-4 shrink-0 transition-transform duration-300"
            ></span>
          </button>
          <div
            id="prompts-collapse-content"
            class="collapse hidden w-full overflow-hidden transition-[height] duration-300"
            aria-labelledby="prompts-collapse"
          >
            <div>
              <ul class="menu space-y-0.5 w-full" id="prompts-list">
                <li class="w-full">
                  <a
                    href="{{ url_for('list', name='prompts') }}"
                    class="text-xs view-all w-full px-4 py-2 hover:bg-base-200 flex items-center rounded-lg"
                  >
                    <span class="truncate">View All Prompts</span>
                  </a>
                </li>
                <li class="w-full">
                  <a
                    href="{{ url_for('doc', name='prompt') }}"
                    class="text-xs w-full px-4 py-2 hover:bg-base-200 flex items-center gap-2 text-primary rounded-lg group"
                  >
                    <span class="icon-[tabler--plus] size-3.5 shrink-0"></span>
                    <span class="truncate">New Prompt</span>
                  </a>
                </li>
                <li class="w-full border-t border-base-200 my-1"></li>
                {% for prompt in prompts %}
                <li class="w-full">
                  <div
                    class="flex items-center gap-2 w-full px-4 py-2 hover:bg-base-200 group rounded-lg"
                  >
                    <a
                      href="{{ url_for('chat.prompt', id=prompt.id) }}"
                      class="flex-1 min-w-0"
                      title="{{ prompt.name }}"
                    >
                      <span class="truncate text-xs block"
                        >{{ prompt.name }}</span
                      >
                    </a>
                    <span
                      class="text-[10px] text-gray-500 whitespace-nowrap shrink-0"
                      >{{ format_time_ago(prompt.modified_date) }}</span
                    >
                    <a
                      href="{{ url_for('prompt.edit', id=prompt.id) }}"
                      class="shrink-0 opacity-0 group-hover:opacity-100 transition-opacity"
                      aria-label="Edit prompt"
                      title="Edit prompt"
                    >
                      <span
                        class="icon-[tabler--edit] size-3.5 text-primary"
                      ></span>
                    </a>
                  </div>
                </li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </li>
        <li class="w-full space-y-0.5">
          <button
            type="button"
            class="collapse-toggle w-full flex items-center gap-2 px-4 py-2 collapse-open:bg-base-content/10"
            id="history-collapse"
            aria-expanded="false"
            aria-controls="history-collapse-content"
            data-collapse="#history-collapse-content"
          >
            <span class="icon-[tabler--clock] size-5 shrink-0"></span>
            <span class="truncate flex-1">History</span>
            <span
              class="icon-[tabler--chevron-down] collapse-open:rotate-180 size-4 shrink-0 transition-transform duration-300"
            ></span>
          </button>
          <div
            id="history-collapse-content"
            class="collapse hidden w-full overflow-hidden transition-[height] duration-300"
            aria-labelledby="history-collapse"
          >
            <div>
              <ul class="menu space-y-0.5 w-full" id="history-list">
                <li class="w-full">
                  <a
                    href="{{ url_for('list', name='history') }}"
                    class="text-xs view-all w-full px-4 py-2 hover:bg-base-200 flex items-center rounded-lg"
                  >
                    <span class="truncate">View All History</span>
                  </a>
                </li>
                <li class="w-full">
                  <button
                    type="button"
                    class="text-xs w-full px-4 py-2 hover:bg-base-200 flex items-center gap-2 text-error rounded-lg group"
                    onclick="handleDeleteHistory()"
                  >
                    <span class="icon-[tabler--trash] size-3.5 shrink-0"></span>
                    <span class="truncate">Delete Documents</span>
                  </button>
                </li>
                <li class="w-full border-t border-base-200 my-1"></li>
                {% for item in history %}
                <li class="w-full">
                  <a
                    href="{{ url_for('chat.history', id=item.id) }}"
                    class="flex items-center gap-2 w-full px-4 py-2 hover:bg-base-200 rounded-lg"
                    title="{{ item.first_message or 'Untitled Chat' }}"
                  >
                    <span class="truncate flex-1 text-xs"
                      >{{ item.first_message or "Untitled Chat" }}</span
                    >
                    <span
                      class="text-[10px] text-gray-500 whitespace-nowrap shrink-0"
                      >{{ format_time_ago(item.modified_date) }}</span
                    >
                  </a>
                </li>
                {% endfor %}
              </ul>
            </div>
          </div>
        </li>
      </ul>
    </div>

    <!-- Fixed Footer Section -->
    <div class="flex-none border-t border-base-200 px-2 pt-4 pb-2 lg:hidden">
      <form action="{{ url_for('logout') }}" method="post" class="w-full">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <button
          type="submit"
          class="btn btn-ghost w-full justify-start gap-2 text-error"
        >
          <span class="icon-[tabler--logout-2] size-5 shrink-0"></span>
          <span class="truncate">Sign Out</span>
        </button>
      </form>
    </div>
  </div>
</aside>

<script>
  // Add error notification function
  function showErrorNotification(message) {
    console.error(message);
  }

  // Function to format date
  function formatDate(dateString) {
    let date;
    if (typeof dateString === "string") {
      // Try to parse the formatted date string from mongoToJson (DD.MM.YYYY HH:MM)
      const parts = dateString.split(" ");
      if (parts.length === 2) {
        const [datePart, timePart] = parts;
        const [day, month, year] = datePart.split(".");
        const [hours, minutes] = timePart.split(":");
        date = new Date(year, month - 1, day, hours, minutes);
      } else {
        date = new Date(dateString);
      }
    } else if (dateString?.$date) {
      // Handle MongoDB ISODate format
      date = new Date(dateString.$date);
    } else {
      return "";
    }

    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);

    if (diffMins < 1) {
      return "just now";
    } else if (diffMins < 60) {
      return `${diffMins}m ago`;
    } else if (diffHours < 24) {
      return `${diffHours}h ago`;
    } else if (diffDays === 1) {
      return "yesterday";
    } else if (diffDays < 7) {
      return `${diffDays}d ago`;
    } else {
      return date.toLocaleDateString();
    }
  }

  // Function to fetch and update nav items with improved error handling
  async function updateNavItems() {
    try {
      const response = await fetch("{{ url_for('dms_chat.get_nav_items') }}");
      if (!response.ok) {
        throw new Error(`Failed to fetch nav items: ${response.status}`);
      }

      const data = await response.json();
      console.log("Total history items received:", data.history.length);

      // Validate data structure
      if (
        !data ||
        !Array.isArray(data.prompts) ||
        !Array.isArray(data.history)
      ) {
        throw new Error("Invalid navigation data structure");
      }

      // Update prompts list
      const promptsList = document.getElementById("prompts-list");
      if (promptsList) {
        // Keep the view all and new prompt links
        const staticLinks = promptsList.querySelectorAll("li:nth-child(-n+3)");
        promptsList.innerHTML = "";
        staticLinks.forEach((link) =>
          promptsList.appendChild(link.cloneNode(true)),
        );

        // Add prompts with error handling
        data.prompts.forEach((prompt) => {
          try {
            if (!prompt?._id?.$oid || !prompt?.name) {
              console.warn("Invalid prompt data:", prompt);
              return;
            }

            console.log("Prompt modified date:", prompt.modified_date);
            const formattedDate = formatDate(prompt.modified_date);
            console.log("Formatted date:", formattedDate);

            const li = document.createElement("li");
            li.className = "w-full";
            li.innerHTML = `
              <div class="flex items-center gap-2 w-full px-4 py-2 hover:bg-base-200 group rounded-lg">
                <a href="/chat/prompt/${prompt._id.$oid}" class="flex-1 min-w-0" title="${prompt.name}">
                  <span class="truncate text-xs block">${prompt.name}</span>
                </a>
                <span class="text-[10px] text-gray-500 whitespace-nowrap shrink-0">${formattedDate}</span>
                <a href="/d/prompt/${prompt._id.$oid}" class="shrink-0 opacity-0 group-hover:opacity-100 transition-opacity" aria-label="Edit prompt" title="Edit prompt">
                  <span class="icon-[tabler--edit] size-3.5 text-primary"></span>
                </a>
              </div>
            `;
            promptsList.appendChild(li);
          } catch (itemError) {
            console.warn("Error adding prompt item:", itemError);
          }
        });
      }

      // Update history list
      const historyList = document.getElementById("history-list");
      if (historyList) {
        // Keep only the view all link
        const viewAllLink = historyList
          .querySelector(".view-all")
          ?.closest("li");
        historyList.innerHTML = "";
        if (viewAllLink) historyList.appendChild(viewAllLink);

        let addedCount = 0;
        // Add history items with error handling
        data.history.forEach((item) => {
          try {
            if (!item?._id?.$oid) {
              return;
            }

            const li = document.createElement("li");
            li.className = "w-full";
            li.innerHTML = `
              <a href="/chat/history/${item._id.$oid}" 
                 class="flex items-center gap-2 w-full px-4 py-2 hover:bg-base-200 rounded-lg"
                 title="${item.first_message || "Untitled Chat"}">
                <span class="truncate flex-1 text-xs">${item.first_message || "Untitled Chat"}</span>
                <span class="text-[10px] text-gray-500 whitespace-nowrap shrink-0">${formatDate(item.modified_date)}</span>
              </a>
            `;
            historyList.appendChild(li);
            addedCount++;
          } catch (itemError) {
            console.warn("Error adding history item:", itemError);
          }
        });
        console.log("Actually added history items:", addedCount);
      }
    } catch (error) {
      console.error("Error updating navigation:", error);
      showErrorNotification(
        "Failed to update navigation. Please refresh the page.",
      );
    }
  }

  // Function to handle history deletion
  async function handleDeleteHistory() {
    if (
      !confirm(
        "Are you sure you want to delete all history documents? This action cannot be undone.",
      )
    ) {
      return;
    }

    try {
      const response = await fetch(
        "{{ url_for('dms_chat.delete_all_history') }}",
        {
          method: "POST",
          headers: {
            "X-CSRFToken": "{{ csrf_token() }}",
          },
        },
      );

      if (!response.ok) {
        throw new Error("Failed to delete history");
      }

      const result = await response.json();

      // Check if we're on a history page
      const currentPath = window.location.pathname;
      if (currentPath.includes("/chat/history/")) {
        // Redirect to index page
        window.location.href = "/";
        return;
      }

      // Update the navigation items
      await updateNavItems();
    } catch (error) {
      console.error("Error deleting history:", error);
      showErrorNotification("Failed to delete history. Please try again.");
    }
  }

  // Initialize nav items when the page loads
  document.addEventListener("DOMContentLoaded", updateNavItems);

  // Update nav items periodically with a debounce
  let updateTimeout = null;
  function debouncedUpdate() {
    if (updateTimeout) {
      clearTimeout(updateTimeout);
    }
    updateTimeout = setTimeout(updateNavItems, 500);
  }

  // Update every 30 seconds, but use debouncing to prevent overlapping calls
  setInterval(debouncedUpdate, 30000);
</script>
