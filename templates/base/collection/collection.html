<!doctype html>
<html lang="en" class="overflow-y-scroll">
  {% include('/main/header.html') %}
  <body class="bg-gray-50 min-h-screen">
    {% include('/main/nav.html') %}

    <section class="p-4 sm:p-6 flex items-center lg:ml-64">
      <div class="max-w-screen-xl mx-auto px-2 sm:px-4 lg:px-12 w-full">
        <div
          class="relative bg-white shadow-md dark:bg-gray-800 sm:rounded-lg p-3 sm:p-4"
        >
          <div class="flex flex-col gap-4">
            <div
              class="flex flex-row justify-between items-center gap-2 sm:gap-4"
            >
              <div class="flex-1">
                <form
                  method="GET"
                  action="{{ url_for('list', collection=collection_name, start=start, limit=limit, filter=filter) }}"
                >
                  <div class="relative">
                    <div
                      class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none"
                    >
                      <svg
                        class="w-4 h-4 text-gray-500"
                        fill="currentColor"
                        viewBox="0 0 20 20"
                      >
                        <path
                          fill-rule="evenodd"
                          d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                          clip-rule="evenodd"
                        ></path>
                      </svg>
                    </div>
                    <input
                      type="text"
                      name="search"
                      class="w-full max-w-md pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
                      placeholder="Search"
                      value="{{ search }}"
                    />
                  </div>
                </form>
              </div>

              <div class="flex-none">
                <a
                  href="{{ url_for('doc',name = collection_name) }}"
                  class="btn btn-primary whitespace-nowrap"
                >
                  New
                </a>
              </div>
            </div>

            {% include('/base/collection/table.html') %}
          </div>
        </div>
      </div>
    </section>

    <!-- Delete Modal -->
    <div
      id="deleteModal"
      tabindex="-1"
      class="hidden overflow-y-auto overflow-x-hidden bg-gray-600 bg-opacity-65 backdrop-blur-sm fixed top-0 right-0 left-0 z-50 flex justify-center items-center w-full h-full"
    >
      <div id="modalContent" class="relative p-4 w-full max-w-md max-h-full">
        <div class="relative bg-white rounded-lg shadow">
          <button
            type="button"
            class="absolute top-3 right-2.5 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center"
            id="closeModal"
          >
            <svg
              class="w-3 h-3"
              aria-hidden="true"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 14 14"
            >
              <path
                stroke="currentColor"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"
              />
            </svg>
            <span class="sr-only">Close modal</span>
          </button>
          <div class="p-4 md:p-5 text-center">
            <svg
              class="mx-auto mb-4 text-gray-400 w-12 h-12"
              aria-hidden="true"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 20 20"
            >
              <path
                stroke="currentColor"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10 11V6m0 8h.01M19 10a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"
              />
            </svg>
            <h3 class="mb-5 text-lg font-normal text-gray-500">
              Are you sure?
            </h3>
            <button
              id="confirmDelete"
              type="button"
              class="text-white bg-red-600 hover:bg-red-800 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center"
            >
              Yes, I'm sure
            </button>
            <button
              id="cancelDelete"
              type="button"
              class="py-2.5 px-5 ms-3 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-4 focus:ring-gray-100"
            >
              No, cancel
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="{{ url_for('static', filename='js/lib/flyonui.js') }}"></script>
    <script>
      document.querySelectorAll(".delete-btn").forEach((button) => {
        button.addEventListener("click", function () {
          const id = this.dataset.id;
          const type = this.dataset.type;
          const modal = document.getElementById("deleteModal");
          const modalContent = document.getElementById("modalContent");
          const confirmDelete = document.getElementById("confirmDelete");
          const cancelDelete = document.getElementById("cancelDelete");
          const closeButton = document.getElementById("closeModal");

          // Show modal
          modal.classList.remove("hidden");

          // Handle delete confirmation
          const handleDelete = () => {
            const url = "{{ url_for('delete_document') }}";

            fetch(url + "?id=" + id + "&type=" + type, {
              method: "GET",
              headers: {
                "X-CSRFToken": "{{ csrf_token() }}",
              },
            })
              .then((response) => response.json())
              .then((result) => {
                if (result.status === "ok") {
                  // Remove the row from the table
                  const row = button.closest("tr");
                  row.remove();

                  // Show success notification
                  const notification = document.createElement("div");
                  notification.className =
                    "fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded shadow-lg z-50";
                  notification.textContent = "Document deleted successfully";
                  document.body.appendChild(notification);
                  setTimeout(() => notification.remove(), 3000);
                } else {
                  // Show error notification
                  const notification = document.createElement("div");
                  notification.className =
                    "fixed bottom-4 right-4 bg-red-500 text-white px-6 py-3 rounded shadow-lg z-50";
                  notification.textContent =
                    "Error deleting document: " + result.message;
                  document.body.appendChild(notification);
                  setTimeout(() => notification.remove(), 3000);
                }
              })
              .catch((error) => {
                console.error("Error:", error);
                // Show error notification
                const notification = document.createElement("div");
                notification.className =
                  "fixed bottom-4 right-4 bg-red-500 text-white px-6 py-3 rounded shadow-lg z-50";
                notification.textContent = "Error deleting document";
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
              })
              .finally(() => {
                modal.classList.add("hidden");
                cleanup();
              });
          };

          // Handle modal close
          const handleClose = () => {
            modal.classList.add("hidden");
            cleanup();
          };

          // Cleanup event listeners
          const cleanup = () => {
            confirmDelete.removeEventListener("click", handleDelete);
            cancelDelete.removeEventListener("click", handleClose);
            closeButton.removeEventListener("click", handleClose);
            modal.removeEventListener("click", handleOutsideClick);
          };

          // Handle click outside modal
          const handleOutsideClick = (event) => {
            if (!modalContent.contains(event.target)) {
              handleClose();
            }
          };

          // Add event listeners
          confirmDelete.addEventListener("click", handleDelete);
          cancelDelete.addEventListener("click", handleClose);
          closeButton.addEventListener("click", handleClose);
          modal.addEventListener("click", handleOutsideClick);
        });
      });
    </script>
  </body>
</html>
